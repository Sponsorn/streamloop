<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StreamLoop - Admin</title>
  <link rel="stylesheet" href="/admin/admin.css">
</head>
<body>

  <!-- ===== SETUP WIZARD ===== -->
  <div id="view-wizard" class="hidden">
    <div class="wizard">
      <!-- Progress bar -->
      <div class="wiz-progress">
        <div class="wiz-progress-dot completed" data-step="1"><span class="wiz-dot-num">1</span><span class="wiz-dot-label">Welcome</span></div>
        <div class="wiz-progress-line" data-after="1"></div>
        <div class="wiz-progress-dot" data-step="2"><span class="wiz-dot-num">2</span><span class="wiz-dot-label">OBS WebSocket</span></div>
        <div class="wiz-progress-line" data-after="2"></div>
        <div class="wiz-progress-dot" data-step="3"><span class="wiz-dot-num">3</span><span class="wiz-dot-label">Browser Source</span></div>
        <div class="wiz-progress-line" data-after="3"></div>
        <div class="wiz-progress-dot" data-step="4"><span class="wiz-dot-num">4</span><span class="wiz-dot-label">Playlists</span></div>
        <div class="wiz-progress-line" data-after="4"></div>
        <div class="wiz-progress-dot" data-step="5"><span class="wiz-dot-num">5</span><span class="wiz-dot-label">Extras</span></div>
        <div class="wiz-progress-line" data-after="5"></div>
        <div class="wiz-progress-dot" data-step="6"><span class="wiz-dot-num">6</span><span class="wiz-dot-label">Finish</span></div>
      </div>

      <!-- Step 1: Welcome -->
      <div class="wiz-step" data-step="1">
        <h2>Welcome to StreamLoop</h2>
        <p>This app plays YouTube playlists in OBS and automatically recovers from freezes, errors, and failures.</p>
        <div class="wiz-info-box">
          <div class="wiz-info-title">What we'll set up:</div>
          <ol class="wiz-checklist-preview">
            <li>Connect to OBS via WebSocket</li>
            <li>Create a Browser Source in OBS for the player</li>
            <li>Add your YouTube playlists</li>
            <li>Optional: Discord alerts &amp; Windows autostart</li>
          </ol>
        </div>
        <div class="wiz-info-box wiz-info-reminder">
          <div class="wiz-info-title">Before you begin</div>
          <p>Make sure OBS Studio is open and running. You'll need it for the next steps.</p>
        </div>
      </div>

      <!-- Step 2: OBS WebSocket -->
      <div class="wiz-step hidden" data-step="2">
        <h2>OBS WebSocket Connection</h2>
        <p>StreamLoop talks to OBS through WebSocket. Let's make sure it's enabled.</p>
        <div class="wiz-info-box">
          <div class="wiz-info-title">In OBS, follow these steps:</div>
          <ol class="wiz-instructions">
            <li>Open OBS and go to <strong>Tools</strong> in the menu bar</li>
            <li>Click <strong>WebSocket Server Settings</strong></li>
            <li>Check <strong>Enable WebSocket Server</strong></li>
            <li>The default port is <strong>4455</strong> &mdash; leave it as-is unless you changed it</li>
            <li>If you set a password, enter it below. Otherwise leave it blank.</li>
            <li>Click <strong>OK</strong> to save</li>
          </ol>
        </div>
        <div class="form-group">
          <label for="wiz-obs-pass">OBS WebSocket Password</label>
          <input type="password" id="wiz-obs-pass" placeholder="Leave blank if no password is set">
          <div class="hint">Only needed if you enabled authentication in OBS WebSocket settings</div>
        </div>
        <div class="wiz-test-row">
          <button type="button" class="btn btn-secondary" id="wiz-test-obs" onclick="wizTestObs()">Test Connection</button>
          <span class="wiz-test-result" id="wiz-obs-result"></span>
        </div>
      </div>

      <!-- Step 3: OBS Browser Source -->
      <div class="wiz-step hidden" data-step="3">
        <h2>Create OBS Browser Source</h2>
        <p>The player runs inside an OBS Browser Source. Let's create one.</p>
        <div class="wiz-info-box">
          <div class="wiz-info-title">In OBS, follow these steps:</div>
          <ol class="wiz-instructions">
            <li>In the <strong>Sources</strong> panel, click the <strong>+</strong> button</li>
            <li>Choose <strong>Browser</strong></li>
            <li>Name it (e.g. <strong>Playlist Player</strong>) and click OK</li>
            <li>Set the <strong>URL</strong> to the address shown below</li>
            <li>Set <strong>Width</strong> to <strong>1920</strong> and <strong>Height</strong> to <strong>1080</strong> (or match your canvas)</li>
            <li>Click <strong>OK</strong> to create the source</li>
          </ol>
        </div>
        <div class="wiz-copy-box">
          <label>Player URL</label>
          <div class="wiz-copy-row">
            <code id="wiz-player-url"></code>
            <button type="button" class="btn btn-secondary btn-small" onclick="wizCopyUrl()">Copy</button>
          </div>
        </div>
        <div class="form-group">
          <label for="wiz-source">OBS Browser Source Name</label>
          <input type="text" id="wiz-source" placeholder="Playlist Player" value="Playlist Player">
          <div class="hint">Enter the exact name you gave the Browser Source in OBS</div>
        </div>
        <div class="wiz-test-row">
          <button type="button" class="btn btn-secondary" id="wiz-test-player" onclick="wizTestPlayer()">Check Player</button>
          <span class="wiz-test-result" id="wiz-player-result"></span>
        </div>
      </div>

      <!-- Step 4: YouTube Playlists -->
      <div class="wiz-step hidden" data-step="4">
        <h2>YouTube Playlists</h2>
        <p>Add the YouTube playlists you want to play. Videos will play in order across all playlists.</p>
        <div class="wiz-info-box">
          <div class="wiz-info-title">Where to find a playlist ID</div>
          <div class="wiz-url-diagram">
            <code>youtube.com/playlist?list=<strong>PLxxxxxxxxxxxxxxxx</strong></code>
          </div>
          <p class="wiz-url-hint">Copy the part after <strong>list=</strong> &mdash; it starts with <strong>PL</strong></p>
          <p class="wiz-url-hint" style="margin-top: 8px;"><strong>Note:</strong> YouTube limits playlists to 200 videos in the embedded player. If your playlist has more, split it into multiple playlists of 200 or fewer.</p>
        </div>
        <div class="form-group">
          <label>Playlists</label>
          <div id="wiz-playlists-list"></div>
          <button type="button" class="btn btn-secondary" onclick="wizAddPlaylist()">+ Add Playlist</button>
        </div>
      </div>

      <!-- Step 5: Optional Extras -->
      <div class="wiz-step hidden" data-step="5">
        <h2>Optional Extras</h2>
        <p>These are completely optional. You can skip this step or set them up later in Settings.</p>
        <div class="form-group">
          <label for="wiz-discord">Discord Webhook URL</label>
          <input type="url" id="wiz-discord" placeholder="https://discord.com/api/webhooks/...">
          <div class="hint">Get notified about errors and recovery actions</div>
          <details class="wiz-collapsible">
            <summary>How do I create a Discord webhook?</summary>
            <ol class="wiz-instructions">
              <li>Open your Discord server and go to <strong>Server Settings</strong></li>
              <li>Click <strong>Integrations</strong>, then <strong>Webhooks</strong></li>
              <li>Click <strong>New Webhook</strong></li>
              <li>Choose a channel for notifications and give it a name</li>
              <li>Click <strong>Copy Webhook URL</strong> and paste it above</li>
            </ol>
          </details>
        </div>
        <div class="wiz-toggle-row">
          <div>
            <div class="toggle-label">Run on Windows startup</div>
            <div class="toggle-desc">Automatically start the monitor when Windows boots</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="wiz-autostart">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="wiz-optional-badge">Optional &mdash; you can configure these later</div>
      </div>

      <!-- Step 6: Verify & Finish -->
      <div class="wiz-step hidden" data-step="6">
        <h2>Verify &amp; Finish</h2>
        <p>Let's make sure everything is working. Your settings will be saved when you click Finish.</p>
        <div class="wiz-verify-checklist" id="wiz-verify-list">
          <div class="wiz-verify-item" data-check="config">
            <span class="wiz-verify-icon" id="wiz-chk-config">&#9679;</span>
            <span>Save configuration</span>
          </div>
          <div class="wiz-verify-item" data-check="obs">
            <span class="wiz-verify-icon" id="wiz-chk-obs">&#9679;</span>
            <span>OBS WebSocket connected</span>
          </div>
          <div class="wiz-verify-item" data-check="player">
            <span class="wiz-verify-icon" id="wiz-chk-player">&#9679;</span>
            <span>Player connected in OBS</span>
          </div>
        </div>
        <div class="wiz-verify-status" id="wiz-verify-status"></div>
      </div>

      <!-- Navigation buttons -->
      <div class="wiz-nav">
        <button type="button" class="btn btn-secondary" id="wiz-back" onclick="wizBack()">Back</button>
        <button type="button" class="btn btn-primary" id="wiz-next" onclick="wizNext()">Continue</button>
      </div>
    </div>
  </div>

  <!-- ===== DASHBOARD ===== -->
  <div id="view-dashboard" class="hidden">
    <!-- Connection lost banner -->
    <div id="connection-lost" class="connection-lost-banner hidden">
      <div class="connection-lost-content">
        <span>Server unreachable â€” dashboard data may be stale</span>
      </div>
    </div>

    <!-- Update banner -->
    <div id="update-banner" class="update-banner hidden">
      <div class="update-banner-content">
        <span id="update-banner-text">A new version is available!</span>
        <button id="update-btn" class="btn btn-update" onclick="handleUpdate()">Update Now</button>
      </div>
    </div>

    <div class="container">
      <header>
        <h1>StreamLoop</h1>
        <div>
          <span id="header-pill" class="status-pill pill-muted">Loading</span>
          <span id="heartbeat-pill" class="status-pill pill-muted" style="display:none;">Heartbeat: -</span>
          <span id="uptime" class="uptime"></span>
        </div>
      </header>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="monitor">Monitor</button>
        <button class="tab" data-tab="overlays">Overlays</button>
        <button class="tab" data-tab="webhooks">Webhooks</button>
        <button class="tab" data-tab="settings">Settings</button>
      </div>

      <!-- Monitor tab -->
      <div id="panel-monitor" class="tab-panel">
        <!-- Status cards -->
        <div class="cards">
          <div class="card">
            <div class="card-label">Player</div>
            <div class="card-value" id="player-status">-</div>
          </div>
          <div class="card">
            <div class="card-label">OBS</div>
            <div class="card-value" id="obs-status">-</div>
          </div>
          <div class="card">
            <div class="card-label">Recovery</div>
            <div class="card-value" id="recovery-step">-</div>
          </div>
          <div class="card">
            <div class="card-label">Errors</div>
            <div class="card-value" id="errors">-</div>
          </div>
        </div>

        <!-- Now playing -->
        <div class="section">
          <div class="section-title">Now Playing</div>
          <div class="now-playing">
            <div class="np-item">
              <div class="np-label">Playlist</div>
              <div class="np-value" id="np-playlist">-</div>
            </div>
            <div class="np-item np-title-item">
              <div class="np-label">Video Title</div>
              <div class="np-value" id="np-title">-</div>
            </div>
            <div class="np-item">
              <div class="np-label">Video Index</div>
              <div class="np-value" id="np-index">-</div>
            </div>
            <div class="np-item">
              <div class="np-label">Video ID</div>
              <div class="np-value" id="np-videoid">-</div>
            </div>
            <div class="np-item">
              <div class="np-label">Video Time</div>
              <div class="np-value" id="np-time">-</div>
            </div>
            <div class="np-item">
              <div class="np-label">Quality</div>
              <div class="np-value" id="np-quality">-</div>
            </div>
            <div class="np-item">
              <div class="np-label">Last Updated</div>
              <div class="np-value" id="np-updated">-</div>
            </div>
          </div>
        </div>

        <!-- Event log -->
        <div class="section">
          <div class="section-title">Event Log</div>
          <div class="event-log" id="event-log">
            <div class="event-empty">No events yet</div>
          </div>
        </div>
      </div>

      <!-- Overlays tab -->
      <div id="panel-overlays" class="tab-panel hidden">
        <div class="section">
          <div class="section-title">Now Playing Overlay</div>
          <p class="overlays-desc">The "Now Playing" overlay is built into the player browser source. It displays the current video title with a frosted glass effect directly on top of the video.</p>
          <p class="overlays-desc" style="margin-top: 8px;">No extra browser sources needed &mdash; it works automatically.</p>
        </div>
      </div>

      <!-- Webhooks tab -->
      <div id="panel-webhooks" class="tab-panel hidden">
        <!-- Webhook & Identity -->
        <div class="section">
          <div class="section-title">Webhook &amp; Identity</div>
          <div class="settings-panel">
            <div class="form-group">
              <label for="wh-url">Discord Webhook URL</label>
              <div class="obs-path-row">
                <input type="url" id="wh-url" placeholder="https://discord.com/api/webhooks/...">
                <button type="button" class="btn btn-secondary btn-small" onclick="testDiscordWebhook()">Test</button>
              </div>
              <div id="wh-test-result" class="obs-path-result" style="display:none;"></div>
            </div>
            <div class="form-group">
              <label for="wh-bot-name">Bot Name</label>
              <input type="text" id="wh-bot-name" placeholder="StreamLoop (default)">
              <div class="hint">Custom username shown for webhook messages</div>
            </div>
            <div class="form-group">
              <label for="wh-avatar-url">Avatar URL</label>
              <input type="url" id="wh-avatar-url" placeholder="https://example.com/avatar.png">
              <div class="hint">Custom avatar image URL for webhook messages</div>
            </div>
            <div class="form-group">
              <label for="wh-role-ping">Role Ping ID</label>
              <input type="text" id="wh-role-ping" placeholder="e.g. 123456789012345678">
              <div class="hint">Discord role ID to @mention on critical alerts only</div>
            </div>
          </div>
        </div>

        <!-- Event Notifications -->
        <div class="section">
          <div class="section-title">Event Notifications</div>
          <div class="settings-panel">
            <div class="wh-toggle">
              <div><div class="toggle-label">Playback Errors</div><div class="toggle-desc">When a video encounters a playback error</div></div>
              <label class="toggle"><input type="checkbox" id="wh-evt-error"><span class="toggle-slider"></span></label>
            </div>
            <div class="wh-toggle">
              <div><div class="toggle-label">Video Skips</div><div class="toggle-desc">When a video is skipped due to errors</div></div>
              <label class="toggle"><input type="checkbox" id="wh-evt-skip"><span class="toggle-slider"></span></label>
            </div>
            <div class="wh-toggle">
              <div><div class="toggle-label">Recovery Actions</div><div class="toggle-desc">When recovery steps are executed (retry, refresh, toggle)</div></div>
              <label class="toggle"><input type="checkbox" id="wh-evt-recovery"><span class="toggle-slider"></span></label>
            </div>
            <div class="wh-toggle">
              <div><div class="toggle-label">Critical Alerts</div><div class="toggle-desc">When all recovery steps are exhausted</div></div>
              <label class="toggle"><input type="checkbox" id="wh-evt-critical"><span class="toggle-slider"></span></label>
            </div>
            <div class="wh-toggle">
              <div><div class="toggle-label">Playback Resumed</div><div class="toggle-desc">When playback successfully resumes after recovery</div></div>
              <label class="toggle"><input type="checkbox" id="wh-evt-resume"><span class="toggle-slider"></span></label>
            </div>
            <div class="wh-toggle">
              <div><div class="toggle-label">OBS Disconnected</div><div class="toggle-desc">When connection to OBS is lost</div></div>
              <label class="toggle"><input type="checkbox" id="wh-evt-obsDisconnect"><span class="toggle-slider"></span></label>
            </div>
            <div class="wh-toggle">
              <div><div class="toggle-label">OBS Reconnected</div><div class="toggle-desc">When OBS connection is restored</div></div>
              <label class="toggle"><input type="checkbox" id="wh-evt-obsReconnect"><span class="toggle-slider"></span></label>
            </div>
          </div>
        </div>

        <!-- Message Templates -->
        <div class="section">
          <div class="section-title">Message Templates</div>
          <div id="wh-templates-container"></div>
        </div>

        <!-- Preview -->
        <div class="section">
          <div class="section-title">Preview</div>
          <div class="settings-panel">
            <div class="form-group">
              <label for="wh-preview-select">Event Type</label>
              <select id="wh-preview-select" class="wh-preview-select">
                <option value="error">Playback Error</option>
                <option value="skip">Video Skip</option>
                <option value="recovery">Recovery Action</option>
                <option value="critical">Critical Alert</option>
                <option value="resume">Playback Resumed</option>
                <option value="obsDisconnect">OBS Disconnected</option>
                <option value="obsReconnect">OBS Reconnected</option>
              </select>
            </div>
            <div class="wh-discord-preview" id="wh-preview">
              <div class="wh-preview-color-bar" id="wh-preview-bar"></div>
              <div class="wh-preview-body">
                <div class="wh-preview-title" id="wh-preview-title"></div>
                <div class="wh-preview-desc" id="wh-preview-desc"></div>
                <div class="wh-preview-fields" id="wh-preview-fields"></div>
                <div class="wh-preview-footer" id="wh-preview-footer"></div>
              </div>
            </div>
          </div>
        </div>

        <button type="button" id="wh-save-btn" class="btn btn-primary" onclick="handleWebhookSave()">Save Webhook Settings</button>
      </div>

      <!-- Settings tab -->
      <div id="panel-settings" class="tab-panel hidden">
        <div class="settings-panel">
          <form id="settings-form">
            <div class="form-group">
              <label>YouTube Playlists</label>
              <div id="set-playlists-list"></div>
              <button type="button" class="btn btn-secondary" onclick="addSetPlaylist()">+ Add Playlist</button>
            </div>
            <div class="form-group">
              <label for="set-source">OBS Browser Source Name</label>
              <input type="text" id="set-source" required>
            </div>
            <div class="form-group">
              <label for="set-obs-pass">OBS WebSocket Password</label>
              <input type="password" id="set-obs-pass">
            </div>
          </form>
        </div>

        <!-- OBS Auto-Restart -->
        <div class="section" style="margin-top: 20px;">
          <div class="section-title">OBS Recovery</div>
          <div class="toggle-row">
            <div>
              <div class="toggle-label">Relaunch OBS on crash</div>
              <div class="toggle-desc">Automatically restart OBS if it closes or crashes</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="obs-restart-toggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="toggle-row" style="margin-top: 8px;">
            <div>
              <div class="toggle-label">Auto-start streaming</div>
              <div class="toggle-desc">Automatically start streaming after OBS reconnects (disable for testing)</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="obs-stream-toggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="form-group" style="margin-top: 12px;">
            <label for="set-obs-path">OBS Executable Path</label>
            <div class="obs-path-row">
              <input type="text" id="set-obs-path" placeholder="Auto-detect (Program Files)">
              <button type="button" class="btn btn-secondary btn-small" onclick="detectObsPath()">Detect</button>
              <button type="button" class="btn btn-secondary btn-small" onclick="validateObsPath()">Validate</button>
            </div>
            <div class="obs-path-result" id="obs-path-result"></div>
            <div class="hint">Should look like: <code>C:\Program Files\obs-studio\bin\64bit\obs64.exe</code></div>
            <div class="hint">Leave blank to auto-detect from default install locations</div>
          </div>
        </div>

        <button type="button" id="set-btn" class="btn btn-primary" style="margin-top: 20px;">Save Settings</button>

        <!-- Autostart -->
        <div class="section" style="margin-top: 20px;">
          <div class="section-title">Startup</div>
          <div class="toggle-row">
            <div>
              <div class="toggle-label">Run on Windows startup</div>
              <div class="toggle-desc">Automatically start the monitor when Windows boots</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="autostart-toggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- Updates -->
        <div class="section" style="margin-top: 20px;">
          <div class="section-title">Updates</div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <button type="button" id="check-update-btn" class="btn btn-secondary">Check for Updates</button>
            <button type="button" id="settings-update-btn" class="btn btn-update hidden" onclick="handleUpdate()">Update Now</button>
            <span id="check-update-result" style="font-size: 13px; color: var(--text-muted);"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container" class="toast-container"></div>
  <script src="/admin/admin.js"></script>
</body>
</html>
